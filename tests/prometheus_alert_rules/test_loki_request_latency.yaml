# Unit tests for LokiRequestLatency alert rule
rule_files:
  - ../../src/prometheus_alert_rules/loki_request_latency.rule

evaluation_interval: 1m

tests:
  # Test case 1: Alert should fire when latency exceeds threshold on a specific route
  - interval: 1m
    input_series:
      # Simulating histogram buckets where 99% of requests are over 2.5 seconds
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="0.005"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="0.01"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="0.025"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="0.05"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="0.1"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="0.25"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="0.5"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="1"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="2.5"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="5"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="10"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="+Inf"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'

    alert_rule_test:
      # Should not fire before the 'for' duration passes
      - eval_time: 4m
        alertname: LokiRequestLatency
        exp_alerts: []
      # Should fire after the 'for' duration
      - eval_time: 6m
        alertname: LokiRequestLatency
        exp_alerts:
          - exp_labels:
              severity: critical
              namespace: test
              job: loki
              route: loki_api_v1_push
            exp_annotations:
              summary: 'Loki request latency for route loki_api_v1_push (job loki)'

  # Test case 2: Alert should NOT fire when latency is below threshold
  - interval: 1m
    input_series:
      # Simulating histogram buckets where 99% of requests are under 0.05 seconds
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query", le="0.005"}'
        values: '0 0 0 0 0 0 0 0 0 0 0 0'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query", le="0.01"}'
        values: '0 0 0 0 0 0 0 0 0 0 0 0'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query", le="0.025"}'
        values: '0 10 20 30 40 50 60 70 80 90 100 110'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query", le="0.05"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query", le="0.1"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query", le="0.25"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query", le="0.5"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query", le="1"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query", le="2.5"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query", le="5"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query", le="10"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query", le="+Inf"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'

    alert_rule_test:
      - eval_time: 6m
        alertname: LokiRequestLatency
        exp_alerts: []

  # Test case 3: Alert should NOT fire for tail routes (excluded by filter)
  - interval: 1m
    input_series:
      # High latency but on a tail route - should be excluded
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_tail", le="0.005"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_tail", le="0.01"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_tail", le="0.025"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_tail", le="0.05"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_tail", le="0.1"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_tail", le="0.25"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_tail", le="0.5"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_tail", le="1"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_tail", le="2.5"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_tail", le="5"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_tail", le="10"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_tail", le="+Inf"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'

    alert_rule_test:
      - eval_time: 6m
        alertname: LokiRequestLatency
        exp_alerts: []

  # Test case 4: Alert should fire separately for multiple routes with high latency
  - interval: 1m
    input_series:
      # High latency on push route
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="0.005"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="0.01"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="0.025"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="0.05"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="0.1"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="0.25"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="0.5"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="1"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="2.5"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="5"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="10"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_push", le="+Inf"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      # High latency on query_range route (slower than push)
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query_range", le="0.005"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query_range", le="0.01"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query_range", le="0.025"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query_range", le="0.05"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query_range", le="0.1"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query_range", le="0.25"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query_range", le="0.5"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query_range", le="1"}'
        values: '0 1 2 3 4 5 6 7 8 9 10 11'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query_range", le="2.5"}'
        values: '0 50 100 150 200 250 300 350 400 450 500 550'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query_range", le="5"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query_range", le="10"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'
      - series: 'loki_request_duration_seconds_bucket{namespace="test", job="loki", route="loki_api_v1_query_range", le="+Inf"}'
        values: '0 100 200 300 400 500 600 700 800 900 1000 1100'

    alert_rule_test:
      - eval_time: 6m
        alertname: LokiRequestLatency
        exp_alerts:
          - exp_labels:
              severity: critical
              namespace: test
              job: loki
              route: loki_api_v1_push
            exp_annotations:
              summary: 'Loki request latency for route loki_api_v1_push (job loki)'
          - exp_labels:
              severity: critical
              namespace: test
              job: loki
              route: loki_api_v1_query_range
            exp_annotations:
              summary: 'Loki request latency for route loki_api_v1_query_range (job loki)'
